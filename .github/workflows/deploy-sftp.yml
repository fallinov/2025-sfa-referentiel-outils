# =============================================================================
# Workflow de déploiement automatique en PRODUCTION via SFTP
# =============================================================================
# Ce workflow se déclenche de DEUX façons :
# 1. Sur création d'un TAG : git tag v1.0.0 && git push origin v1.0.0
# 2. Sur création d'une RELEASE GitHub (pour documenter la version)
# Permet de séparer l'environnement de test (GitHub Pages) de la production (SFTP)

name: Deploy to Production (SFTP)

# Déclencheurs du workflow
on:
  # OPTION 1 : Se déclenche sur les tags versionnés (v1.0.0, v0.0.1, etc.)
  # Usage : git tag v1.0.0 && git push origin v1.0.0
  # Pratique pour déploiements rapides sans documentation formelle
  push:
    tags:
      - 'v*.*.*'  # Correspond à v1.0.0, v2.1.3, v0.0.1, etc.

  # OPTION 2 : Se déclenche lorsqu'une release est publiée sur GitHub
  # Usage : Créer une release via https://github.com/.../releases/new
  # Recommandé pour versions majeures avec changelog et documentation
  release:
    types: [published]

  # OPTION 3 : Déclenchement manuel en cas d'urgence
  # Utile pour redéployer rapidement sans créer un nouveau tag/release
  workflow_dispatch:

jobs:
  # =============================================================================
  # JOB : Déploiement en production via SFTP
  # =============================================================================
  # Ce job génère le site statique et l'upload sur le serveur de production

  deploy-production:
    # Système d'exploitation de la machine virtuelle
    runs-on: ubuntu-latest

    # Configuration de l'environnement de production
    environment:
      name: production                            # Nom de l'environnement
      url: ${{ vars.PRODUCTION_URL }}            # URL du site de production (configurable dans GitHub)

    # Liste des étapes à exécuter dans l'ordre
    steps:
      # --- ÉTAPE 1 : Récupérer le code source ---
      # Clone le dépôt GitHub dans la machine virtuelle
      - name: Checkout
        uses: actions/checkout@v4

      # --- ÉTAPE 2 : Installer pnpm (gestionnaire de paquets) ---
      # Version identique au workflow de staging pour garantir la cohérence
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.19.0

      # --- ÉTAPE 3 : Installer Node.js ---
      # Configuration identique au workflow de staging
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"    # Version LTS de Node.js
          cache: 'pnpm'         # Active le cache des dépendances

      # --- ÉTAPE 4 : Installer les dépendances du projet ---
      # --frozen-lockfile garantit les mêmes versions qu'en développement
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # --- ÉTAPE 5 : Générer le site statique pour la production ---
      # IMPORTANT : utilise 'generate:prod' qui configure baseURL à '/' (racine)
      # Contrairement au staging qui utilise '/2025-sfa-nuxt-devops/'
      # NODE_ENV=production active les optimisations (minification, etc.)
      - name: Generate static site for production
        run: pnpm run generate:prod
        env:
          NODE_ENV: production

      # --- ÉTAPE 6 : Déployer sur le serveur de production via SFTP ---
      # Upload tous les fichiers générés (.output/public/) vers le serveur
      # Les credentials SFTP sont stockés de manière sécurisée dans GitHub Secrets
      # IMPORTANT : upload_path avec ./* pour uploader tout le CONTENU du dossier
      - name: Deploy to Production via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_SERVER }}              # Adresse du serveur SFTP
          username: ${{ secrets.SFTP_USERNAME }}          # Nom d'utilisateur SFTP
          password: ${{ secrets.SFTP_PASSWORD }}          # Mot de passe SFTP (sécurisé)
          port: ${{ secrets.SFTP_PORT || 22 }}            # Port SFTP (22 par défaut pour SSH)
          local_path: './.output/public/./'               # Upload le CONTENU du dossier (avec ./ final)
          remote_path: ${{ secrets.SFTP_SERVER_DIR }}     # Dossier de destination sur le serveur
          sftp_only: true                                  # Utiliser SFTP uniquement (pas SCP)
          delete_remote_files: false                       # Ne PAS supprimer les fichiers distants avant upload
